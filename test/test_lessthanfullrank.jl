using StatsBase: isapprox

@testset "Less than full rank regression behaviour" begin
    # The package does not remove collinear terms (when there is a less than full rank matrix).
    # This test only checks that the behaviour is similar to other software package (such as R).
    
    year = [2011, 2011, 2011, 2011, 2012, 2010, 2011, 2010, 2011, 2010, 2010, 2011, 2011, 2010, 2011, 2011, 2010, 2010, 2011, 2011, 2010, 2010, 2011, 2010, 2009, 2010, 2010, 2010, 2010, 2009, 2010, 2009, 2011, 2011, 2009, 2010, 2011, 2010, 2010, 2010, 2010, 2010, 2010, 2009, 2010, 2010, 2010, 2010, 2009, 2009, 2010, 2010, 2010, 2009, 2010, 2010, 2010, 2009, 2009, 2009, 2010, 2010, 2009, 2009, 2009, 2010, 2010, 2010, 2009, 2009, 2009, 2009, 2010, 2009, 2010, 2009, 2009, 2010, 2010, 2010, 2009, 2009, 2007, 2010, 2010, 2010, 2009, 2009, 2009, 2008, 2009, 2009, 2009, 2010, 2010, 2008, 2008, 2009, 2009, 2008, 2009, 2010, 2008, 2009, 2010, 2008, 2008]
    mileage = [7413, 10926, 7351, 11613, 8367, 25125, 27393, 21026, 32655, 36116, 40539, 9199, 9388, 32058, 15367, 16368, 19926, 36049, 11662, 32069, 16035, 39943, 36685, 24920, 20019, 29338, 7784, 35636, 22029, 33107, 36306, 34419, 4867, 18948, 24030, 33036, 23967, 37905, 28955, 11165, 44813, 36469, 22143, 34046, 32703, 35894, 38275, 24855, 29501, 35394, 36447, 35318, 24929, 23785, 15167, 13541, 20278, 46126, 53733, 21108, 21721, 26716, 26887, 36252, 9450, 31414, 37185, 48174, 50533, 36713, 34888, 38380, 35574, 27528, 33302, 43369, 64055, 41342, 34503, 16573, 32403, 34846, 39665, 21325, 32743, 40058, 42325, 44518, 53902, 127327, 27136, 45813, 31538, 29517, 35871, 49787, 36323, 39211, 44789, 45996, 54988, 49720, 36322, 39222, 44089, 45993, 50988]
    price = [21992, 20995, 19995, 17809, 17500, 17495, 17000, 16995, 16995, 16995, 16995, 16992, 16950, 16950, 16000, 15999, 15999, 15995, 15992, 15992, 15988, 15980, 15899, 15889, 15688, 15500, 15499, 15499, 15298, 14999, 14999, 14995, 14992, 14992, 14992, 14990, 14989, 14906, 14900, 14893, 14761, 14699, 14677, 14549, 14499, 14495, 14495, 14480, 14477, 14355, 14299, 14275, 14000, 13999, 13997, 13995, 13995, 13995, 13995, 13992, 13992, 13992, 13992, 13991, 13950, 13950, 13950, 13895, 13888, 13845, 13799, 13742, 13687, 13663, 13599, 13584, 13425, 13384, 13383, 13350, 12999, 12998, 12997, 12995, 12995, 12995, 12995, 12995, 12995, 12995, 12992, 12990, 12988, 12849, 12780, 12777, 12704, 12595, 12507, 12500, 12500, 12773, 12704, 12595, 12519, 12333, 12399]

    df = DataFrame(Year = year, Mileage = mileage , Price = price)

    clm = regress(@formula( Price ~ 1 + Year + Mileage ), df)

    @test isapprox([-2.1875899220039356e6, 1096.1497198779816, -0.023836779513595294] , clm.coefs)
    @test isapprox([352441.774385393, 175.28249088168033, 0.009841450356317822] , clm.stderrors)
    @test isapprox([-6.2069541155238275, 6.2536178848457125, -2.4220799425455644], clm.t_values)
    @test isapprox(3, clm.p)
    @test isapprox(1.697508841124793e6, clm.MSE)
    @test true == clm.intercept
    @test isapprox(0.4643179971701117, clm.R2)
    @test isapprox(0.4540164201926138, clm.ADJR2)
    @test isapprox(1302.884814987416, clm.RMSE)
    @test isapprox([1.1199586251463344e-8, 9.016454363548383e-9, 0.017161942174616873], clm.p_values)

end